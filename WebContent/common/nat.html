<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="basic_layout.css" />
    <style type="text/css"></style>
  </head>
  <script type="text/javascript" src="basic_jscript.js"></script>
  <script type="text/javascript" src="js/jquery-3.7.1.min.js"></script>
  <script type="text/javascript">
    $(document).ajaxError(function (event, request, settings) {
      var obj = JSON.parse(request.responseText);
      if (obj.msg) ffunc(obj.msg);
      if (obj.error === "invalid rights")
        window.top.location.href = "login.html";
    });

    function isValidIPAddress(inputText) {
      var ipformat =
        /^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$/;

      if (inputText.match(ipformat)) {
        return true;
      } else {
        return false;
      }
    }

    function isValidPort(inputText) {
      var portformat = /^([1-9]{1}[0-9]*|[0])$/;

      if (!inputText.match(portformat)) {
        return false;
      }

      var port = parseInt(inputText, 10);
      if (port >= 1 && port <= 65535) return true;
      return false;
    }

    function changeState(state) {
      if (state == false) {
        $("#nat_rules > tbody .table_row_content").remove();
        $("#create_1_1_NAT").prop("disabled", true);
        $("#create_PAT").prop("disabled", true);
      } else {
        $("#create_1_1_NAT").prop("disabled", false);
        $("#create_PAT").prop("disabled", false);
      }
      $("#global_setting").prop("checked", state);
    }

    function getNATState() {
      $.post(
        "/api",
        JSON.stringify({
          service: "nat",
          access: "get",
          command: "state",
        }),
        function (data, status) {
          changeState(data.enabled);
          if (data.enabled) load_rules();
        }
      );
    }

    function setNatState() {
      $.post(
        "/api",
        JSON.stringify({
          service: "nat",
          access: "set",
          command: "state",
          parameters: {
            enabled: $("#global_setting").is(":checked"),
          },
        }),
        function (data, status) {
          changeState(data.enabled);
          if (data.enabled) load_rules();
        }
      );
    }

    function removeRule(idx) {
      $.post(
        "/api",
        JSON.stringify({
          service: "nat",
          access: "remove",
          command: "rule",
          parameters: {
            index: idx,
          },
        }),
        function (data, status) {
          createOK(data);
          update_rules_callback(data);
        }
      );
    }

    function load_rules() {
      $.post(
        "/api",
        JSON.stringify({
          service: "nat",
          access: "get",
          command: "rule",
        }),
        update_rules_callback
      );
    }

    function update_rules_callback(data) {
      $("#nat_rules > tbody .table_row_content").remove();
      var tab = $("#nat_rules")[0];
      for (var i = 0; i < data.length; i++) {
        var tr = tab.insertRow(-1);
        tr.className = "table_row_content";
        var t0 = tr.insertCell(0);
        var t1 = tr.insertCell(1);
        t0.innerText = data[i].name;
        t1.align = "center";
        var bu = document.createElement("input");
        bu.type = "button";
        bu.id = "remove_" + i;
        bu.value = "Remove";
        bu.onclick = function (e) {
          var params = e.target.id.substr(7);
          removeRule(parseInt(params));
        };
        t1.appendChild(bu);
      }
    }

    $(document).ready(function () {
      getNATState();
      $("#ChangeGlobalSetting").click(setNatState);
      $("#create_1_1_NAT").click(function () {
        if (
          !isValidIPAddress($("#1_1_NAT_internal_ip").val()) ||
          $("#1_1_NAT_internal_ip").val() == "0.0.0.0"
        ) {
          alert(
            "error: Device IP Address '" +
              $("#1_1_NAT_internal_ip").val() +
              "' is not a vaild IP Address"
          );
          return;
        }

        if (
          !isValidIPAddress($("#1_1_NAT_external_ip").val()) ||
          $("#1_1_NAT_external_ip").val() == "0.0.0.0"
        ) {
          alert(
            "error: External IP Address '" +
              $("#1_1_NAT_external_ip").val() +
              "' is not a vaild IP Address"
          );
          return;
        }

        var ruleName = "1:1 NAT ";

        if ($("#1_1_NAT_masq").is(":checked")) ruleName += "(Masquerade) ";
        ruleName +=
          $("#1_1_NAT_external_ip").val() +
          " to " +
          $("#1_1_NAT_internal_ip").val();

        //1_1_NAT_masq

        obj = {
          service: "nat",
          access: "add",
          command: "rule",
          parameters: {
            name: ruleName,
            FORWARD: [
              {
                expr: [
                  {
                    match: {
                      op: "==",
                      left: {
                        payload: {
                          protocol: "ip",
                          field: "daddr",
                        },
                      },
                      right: $("#1_1_NAT_internal_ip").val(),
                    },
                  },
                  {
                    accept: null,
                  },
                ],
              },
              {
                expr: [
                  {
                    match: {
                      op: "==",
                      left: {
                        payload: {
                          protocol: "ip",
                          field: "saddr",
                        },
                      },
                      right: $("#1_1_NAT_internal_ip").val(),
                    },
                  },
                  {
                    accept: null,
                  },
                ],
              },
            ],
            PREROUTING: [
              {
                expr: [
                  {
                    match: {
                      op: "==",
                      left: {
                        payload: {
                          protocol: "ip",
                          field: "daddr",
                        },
                      },
                      right: $("#1_1_NAT_external_ip").val(),
                    },
                  },
                  {
                    dnat: {
                      addr: $("#1_1_NAT_internal_ip").val(),
                    },
                  },
                ],
              },
            ],
            POSTROUTING: [
              {
                expr: [
                  {
                    match: {
                      op: "==",
                      left: {
                        payload: {
                          protocol: "ip",
                          field: "saddr",
                        },
                      },
                      right: $("#1_1_NAT_internal_ip").val(),
                    },
                  },
                  {
                    snat: {
                      addr: $("#1_1_NAT_external_ip").val(),
                    },
                  },
                ],
              },
            ],
            ips: [$("#1_1_NAT_external_ip").val()],
          },
        };

        if ($("#1_1_NAT_masq").is(":checked")) {
          obj.parameters.POSTROUTING.push({
            expr: [
              {
                match: {
                  op: "==",
                  left: {
                    payload: {
                      protocol: "ip",
                      field: "daddr",
                    },
                  },
                  right: $("#1_1_NAT_internal_ip").val(),
                },
              },
              {
                masquerade: null,
              },
            ],
          });
        }

        $.post("/api", JSON.stringify(obj), function (data, status) {
          createOK(data);
          update_rules_callback(data);
        });
      });

      $("#create_PAT").click(function () {
        if (
          !isValidIPAddress($("#pat_in_ip").val()) ||
          $("#pat_in_ip").val() == "0.0.0.0"
        ) {
          alert(
            "error: Incoming IP Address '" +
              $("#pat_in_ip").val() +
              "' is not a vaild IP Address"
          );
          return;
        }

        if (!isValidPort($("#pat_in_port").val())) {
          alert(
            "error: Incoming Port '" +
              $("#pat_in_port").val() +
              "' is not vaild"
          );
          return;
        }

        if (
          !isValidIPAddress($("#pat_dest_ip").val()) ||
          $("#pat_dest_ip").val() == "0.0.0.0"
        ) {
          alert(
            "error: Destination IP Address '" +
              $("#pat_dest_ip").val() +
              "' is not a vaild IP Address"
          );
          return;
        }

        if (!isValidPort($("#pat_dest_port").val())) {
          alert(
            "error: Destination Port '" +
              $("#pat_dest_port").val() +
              "' is not vaild"
          );
          return;
        }

        var ruleName = "PAT ";

        if ($("#pat_masq").is(":checked")) ruleName += "(Masquerade) ";
        ruleName += $("#pat_proto").val().toUpperCase() + " ";
        ruleName +=
          $("#pat_in_ip").val() +
          ":" +
          $("#pat_in_port").val() +
          " to " +
          $("#pat_dest_ip").val() +
          ":" +
          $("#pat_dest_port").val();

        var obj = {
          service: "nat",
          access: "add",
          command: "rule",
          parameters: {
            name: ruleName,
            FORWARD: [
              {
                expr: [
                  {
                    match: {
                      op: "==",
                      left: {
                        payload: {
                          protocol: "ip",
                          field: "daddr",
                        },
                      },
                      right: $("#pat_dest_ip").val(),
                    },
                  },
                  {
                    match: {
                      op: "==",
                      left: {
                        payload: {
                          protocol: $("#pat_proto").val(),
                          field: "dport",
                        },
                      },
                      right: parseInt($("#pat_dest_port").val()),
                    },
                  },
                  {
                    accept: null,
                  },
                ],
              },
              {
                expr: [
                  {
                    match: {
                      op: "==",
                      left: {
                        payload: {
                          protocol: "ip",
                          field: "saddr",
                        },
                      },
                      right: $("#pat_dest_ip").val(),
                    },
                  },
                  {
                    match: {
                      op: "==",
                      left: {
                        payload: {
                          protocol: $("#pat_proto").val(),
                          field: "sport",
                        },
                      },
                      right: parseInt($("#pat_dest_port").val()),
                    },
                  },
                  {
                    accept: null,
                  },
                ],
              },
            ],
            PREROUTING: [
              {
                expr: [
                  {
                    match: {
                      op: "==",
                      left: {
                        payload: {
                          protocol: "ip",
                          field: "daddr",
                        },
                      },
                      right: $("#pat_in_ip").val(),
                    },
                  },
                  {
                    match: {
                      op: "==",
                      left: {
                        payload: {
                          protocol: $("#pat_proto").val(),
                          field: "dport",
                        },
                      },
                      right: parseInt($("#pat_in_port").val()),
                    },
                  },
                  {
                    dnat: {
                      addr: $("#pat_dest_ip").val(),
                      port: parseInt($("#pat_dest_port").val()),
                    },
                  },
                ],
              },
            ],
            POSTROUTING: [],
            ips: [],
          },
        };
        if ($("#pat_masq").is(":checked")) {
          obj.parameters.POSTROUTING.push({
            expr: [
              {
                match: {
                  op: "==",
                  left: {
                    payload: {
                      protocol: "ip",
                      field: "daddr",
                    },
                  },
                  right: $("#pat_dest_ip").val(),
                },
              },
              {
                match: {
                  op: "==",
                  left: {
                    payload: {
                      protocol: $("#pat_proto").val(),
                      field: "dport",
                    },
                  },
                  right: parseInt($("#pat_dest_port").val()),
                },
              },
              {
                masquerade: null,
              },
            ],
          });
        }

        $.post("/api", JSON.stringify(obj), function (data, status) {
          createOK(data);
          update_rules_callback(data);
        });
      });
    });
  </script>
  <body
    style="
      height: 100%;
      width: 100%;
      float: left;
      margin: 0px;
      font-family: Verdana;
      overflow: hidden;
      position: absolute;
    "
  >
    <div id="content" style="height: 100%; overflow: auto; width: 100%">
      <h2 style="margin-left: 10px">Settings &gt; NAT</h2>
      <div class="box2" style="width: calc(25% - 20px)">
        <a class="headline">NAT Status</a>
        <table
          class="table"
          style="font-size: 80%; width: 100%; text-align: center"
        >
          <tr class="table_row_head">
            <td>Setting</td>
            <td>Status</td>
          </tr>
          <tr class="table_row_content">
            <td>NAT enabled</td>
            <td>
              <input id="global_setting" type="checkbox" />
            </td>
          </tr>
        </table>
        <input type="button" id="ChangeGlobalSetting" value="Set NAT Status" />
        <br /><br /><br />

        <a class="headline">Create 1:1 NAT</a>
        <table
          class="table"
          style="font-size: 80%; width: 100%; text-align: center"
        >
          <tr class="table_row_head">
            <td class="table_cell">Parameter</td>
            <td class="table_cell">Value</td>
          </tr>
          <tr class="table_row_content">
            <td class="table_cell">Device IP Address</td>
            <td class="table_cell">
              <input id="1_1_NAT_internal_ip" type="text" style="width: 90%" />
            </td>
          </tr>
          <tr class="table_row_content">
            <td class="table_cell">External IP Address</td>
            <td class="table_cell">
              <input id="1_1_NAT_external_ip" type="text" style="width: 90%" />
            </td>
          </tr>
          <tr class="table_row_content">
            <td class="table_cell">Masquerade</td>
            <td class="table_cell">
              <input id="1_1_NAT_masq" type="checkbox" />
            </td>
          </tr>
        </table>
        <input id="create_1_1_NAT" type="button" value="Create 1:1 NAT Rule" />
      </div>
      <div class="box2" style="width: calc(25% - 20px)">
        <a class="headline">Create Port Forwarding</a>
        <table
          class="table"
          style="font-size: 80%; width: 100%; text-align: center"
        >
          <tr class="table_row_head">
            <td class="table_cell">Parameter</td>
            <td class="table_cell">Value</td>
          </tr>
          <tr class="table_row_content">
            <td class="table_cell">Incoming IP Address</td>
            <td class="table_cell">
              <input id="pat_in_ip" type="text" style="width: 90%" />
            </td>
          </tr>
          <tr class="table_row_content">
            <td class="table_cell">Incoming Port</td>
            <td class="table_cell">
              <input
                id="pat_in_port"
                type="number"
                min="1"
                max="65535"
                style="width: 90%"
              />
            </td>
          </tr>
          <tr class="table_row_content">
            <td class="table_cell">Protocol</td>
            <td class="table_cell">
              <select id="pat_proto" style="width: 98%">
                <option value="tcp">TCP</option>
                <option value="udp">UDP</option>
              </select>
            </td>
          </tr>
          <tr class="table_row_content">
            <td class="table_cell">Destination IP Address</td>
            <td class="table_cell">
              <input id="pat_dest_ip" type="text" style="width: 90%" />
            </td>
          </tr>
          <tr class="table_row_content">
            <td class="table_cell">Destination Port</td>
            <td class="table_cell">
              <input
                id="pat_dest_port"
                type="number"
                min="1"
                max="65535"
                style="width: 90%"
              />
            </td>
          </tr>
          <tr class="table_row_content">
            <td class="table_cell">Masquerade</td>
            <td class="table_cell">
              <input id="pat_masq" type="checkbox" />
            </td>
          </tr>
        </table>
        <input id="create_PAT" type="button" value="Create Port Forwarding" />
      </div>
      <div class="box2" style="width: calc(40% - 20px)">
        <a class="headline">NAT List</a>
        <table
          class="table"
          style="font-size: 80%; width: 100%; text-align: center"
          id="nat_rules"
        >
          <tr class="table_row_head">
            <td class="table_cell">Rule</td>
            <td class="table_cell">Action</td>
          </tr>
        </table>
      </div>
    </div>
  </body>
</html>
