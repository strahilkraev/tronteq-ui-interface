<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<html style="height: 100%">
  <head>
    <link rel="stylesheet" type="text/css" href="basic_layout.css" />
    <style type="text/css"></style>
  </head>
  <script type="text/javascript" src="basic_jscript.js"></script>
  <script type="text/javascript" src="js/jquery-3.7.1.min.js"></script>
  <script type="text/javascript">
    function setDefaultArchive() {
      $("#staticLease_opt_dep_arc")[0].value =
        "http://" + window.location.host + "/files/files.tar";
    }

    var gCodes = {
      "Subnet Mask": 1,
      Router: 3,
      "Domain Server": 6,
      "Domain Name": 15,
      "NTP Servers": 42,
    };

    var gTypes = {
      "IP Address": 0,
      "Subnet Mask": 1,
      String: 2,
    };

    function HasTypeMultipleOptions(type) {
      // IP Addresses
      if (type == 0) {
        return true;
      }
      return false;
    }

    $(document).ajaxError(function (event, request, settings) {
      var obj = JSON.parse(request.responseText);
      if (obj.msg) ffunc(obj.msg);
      if (obj.error === "invalid rights")
        window.top.location.href = "login.html";
    });

    $(document).ready(function () {
      setupPortInfo(setup);
    });

    function setup() {
      getVids();
      fillPortSelect();
      getStaticLeases();
      getSubnets();
      change_add_static_lease_type();
      change_add_sub_opt_code();
      $("#staticLease_type")[0].onchange = change_add_static_lease_type;
      change_add_static_lease_opt();
      $("#staticLease_add_opt")[0].onchange = change_add_static_lease_opt;
      $("#add_staticLease")[0].onclick = addStaticLease;
      $("#addOptCode")[0].onchange = change_add_sub_opt_code;
      $("#addSubnetAddOption")[0].onclick = addOptiontoSubnet;
      $("#add_Subnet")[0].onclick = addSubnet;
      $("#update_vids")[0].onclick = setVids;
      setDefaultArchive();
      fillIpInterfaces();
      $("#ipInterfaces")[0].onchange = fillAddr;
      $("#staticLease_ip")[0].onchange = ChangeStaticIp;
    }

    function fillIpInterfaces(data) {
      $.post(
        "/api",
        '{"service":"vlan","access":"get","command":"get current bridge config"}',
        function (data, status) {
          var sel = $("#ipInterfaces")[0];

          for (br = 0; br < data.length; br++) {
            var opt = document.createElement("option");
            opt.value =
              "" + data[br].vlan_id + "|" + data[br].ip + "|" + data[br].sm;
            if (data[br].vlan_id == 0) {
              opt.text = "Lan";
            } else {
              opt.text = "VLAN_ID" + data[br].vlan_id;
            }
            sel.appendChild(opt);
          }
        }
      );
    }

    function getBestServerAddr(ipAddr) {
      var sel = $("#ipInterfaces")[0];
      var resp = window.location.host;
      for (var i = 0; i < sel.options.length; i++) {
        if (sel.options[i].value.length > 2) {
          part = sel.options[i].value.split("|");
          if (part[1].length > 0 && part[2].length > 0) {
            if (
              getNetworkAddr(part[1], part[2]) ==
              getNetworkAddr(ipAddr, part[2])
            )
              return part[1];
          }
        }
      }
      return resp;
    }

    function ChangeStaticIp() {
      leaseIp = $("#staticLease_ip")[0].value;
      if (validate_ipv4(leaseIp)) {
        var ipServer = getBestServerAddr(leaseIp);
        $("#staticLease_opt_dep_arc")[0].value =
          "http://" + ipServer + "/files/files.tar";
      }
    }

    function getNetworkAddr(ipaddr, subnetmask) {
      if (ipaddr.split(".").length != 4 || subnetmask.split(".").length != 4) {
        return;
      }
      resp = "";
      for (var i = 0; i < 4; i++) {
        ip = parseInt(ipaddr.split(".")[i]);
        s = parseInt(subnetmask.split(".")[i]);
        if (i != 0) {
          resp = resp + ".";
        }
        resp = resp + (ip & s);
      }
      return resp;
    }

    function fillAddr() {
      var sel = $("#ipInterfaces")[0];
      data = sel.value.split("|");
      if (data.length != 3) {
        $("#addSubnetIP")[0].value = "";
        $("#addSubnetMask")[0].value = "";
        return;
      }
      $("#addSubnetIP")[0].value = getNetworkAddr(data[1], data[2]);
      $("#addSubnetMask")[0].value = data[2];
    }

    function fillPortSelect() {
      sel = $("#staticLease_p_port")[0];
      for (var i = 0; i < SwitchPortNames.length; ++i) {
        var opt = document.createElement("option");
        opt.value = i;
        opt.text = SwitchPortNames[i];

        sel.appendChild(opt);
      }
    }

    function updateSubnet(e) {
      var target = e.target;
      index = parseInt(target.id.split("_")[1]);

      up_sub = {
        ip: $("#subnet_ip_" + index)[0].innerText,
        mask: $("#subnet_mask_" + index)[0].innerText,
        leasetime: parseInt($("#subnet_lease_time_" + index)[0].value),
        pool_start: $("#subnet_pool_start_" + index)[0].value,
        pool_end: $("#subnet_pool_end_" + index)[0].value,
        options: [],
      };
      opt_rows = $("[id^=subnet_opt_row_" + index + "_]");

      for (var i = 0; i < opt_rows.length; i++) {
        var toAdd = false;
        opt_index = parseInt(opt_rows[i].id.split("_")[4]);
        code = parseInt(
          $(
            "[id^=subnet_opt_data_" + index + "_opt_code_" + opt_index + "]"
          )[0].id.split("__")[1]
        );
        type = parseInt(
          $(
            "[id^=subnet_opt_data_" + index + "_opt_type_" + opt_index + "]"
          )[0].id.split("__")[1]
        );
        obj = {
          code: code,
          type: type,
          value: [],
        };
        // subnet_opt_data_1_opt_val_0_0
        values = $(
          "[id^=subnet_opt_data_" + index + "_opt_val_" + opt_index + "_]"
        );
        for (var j = 0; j < values.length; j++) {
          if (values[j].value.length > 0) {
            toAdd = true;
            obj.value.push(values[j].value);
          }
        }
        if (toAdd) {
          up_sub.options.push(obj);
        }
      }
      cmd = {
        service: "dhcp",
        access: "set",
        command: "edit subnet",
        parameters: up_sub,
      };
      $.post("/api", JSON.stringify(cmd), function (data, status) {
        getSubnets();
      });
    }

    function removeOptionEditSubnet(e) {
      var target = e.target;
      prefix = target.id.substring(0, target.id.length - 6);
      code = parseInt(prefix.split("_")[6]);
      subnet_nr = parseInt(prefix.split("_")[3]);

      row = $("#subnet_opt_row_" + subnet_nr + "_" + code)[0];
      if (row.children.length == 5) {
        row.children[0].rowSpan -= 1;
        var next = row.nextSibling;
        next.insertBefore(row.children[0], next.firstChild);
      } else {
        $("#option_cell_" + subnet_nr)[0].rowSpan -= 1;
      }

      for (const [key, val] of Object.entries(gCodes)) {
        if (val == code) {
          code_sel = $("#subnet_opt_addcode_" + subnet_nr)[0];
          var opt = document.createElement("option");
          opt.value = val;
          opt.text = key;
          code_sel.appendChild(opt);
          change_old_sub_opt_code({ target: code_sel });
        }
      }

      $("#subnet_opt_addbutton_" + subnet_nr)[0].disabled = false;
      row.remove();
    }

    function removeOptionAddSubnet(e) {
      var target = e.target;
      prefix = target.id.substring(0, target.id.length - 6);
      index = parseInt(prefix.split("_")[3]);

      row = $("#addSubnetIP_opt_val_" + index + "row")[0];
      if (row.children.length == 5) {
        row.children[0].rowSpan -= 1;
        var next = row.nextSibling;
        next.insertBefore(row.children[0], next.firstChild);
      } else {
        $("#addSubnetOptionSetting")[0].rowSpan -= 1;
      }
      for (const [key, val] of Object.entries(gCodes)) {
        if (val == index) {
          code_sel = $("#addOptCode")[0];
          var opt = document.createElement("option");
          opt.value = val;
          opt.text = key;
          code_sel.appendChild(opt);
          change_add_sub_opt_code();
        }
      }
      $("#addSubnetAddOption")[0].disabled = false;
      row.remove();
    }

    function addOptionValue(e) {
      var target = e.target;
      prefix = target.id.substring(0, target.id.length - 4);
      values = $("[id^=" + prefix + "_]");
      del = $("#" + prefix + "del")[0];

      if (values.length == 0) {
        alert("Error");
        return;
      } else if (values.length >= 1) {
        target.disabled = true;
      }
      last = values[values.length - 1];
      inp = document.createElement("input");
      inp.id = prefix + "_" + values.length;
      br = document.createElement("br");

      target.parentNode.insertBefore(br, del);
      target.parentNode.insertBefore(inp, del);
      del.disabled = false;
    }

    function removeOptionValue(e) {
      var target = e.target;
      prefix = target.id.substring(0, target.id.length - 3);
      values = $("[id^=" + prefix + "_]");
      add = $("#" + prefix + "plus")[0];
      if (values.length == 0) {
        alert("Error");
        return;
      } else if (values.length >= 1) {
        target.disabled = true;
      }
      last = values[values.length - 1];

      target.parentNode.removeChild(last.previousSibling);
      target.parentNode.removeChild(last);

      add.disabled = false;
    }

    function removeSubnet(e) {
      var target = e.target;
      index = parseInt(target.id.split("_")[1]);
      ip = $("#subnet_ip_" + index)[0].innerText;
      mask = $("#subnet_mask_" + index)[0].innerText;
      $.post(
        "/api",
        '{"service":"dhcp","access":"set","command":"remove subnet","parameters":{"ip": "' +
          ip +
          '", "mask": "' +
          mask +
          '"}}',
        function (data, status) {
          getSubnets();
        }
      );
    }

    function addSubnet() {
      next_sub = {
        ip: $("#addSubnetIP")[0].value,
        mask: $("#addSubnetMask")[0].value,
        leasetime: parseInt($("#addSubnetLeasetime")[0].value),
        pool_start: $("#addSubnetPoolStart")[0].value,
        pool_end: $("#addSubnetPoolEnd")[0].value,
        options: [],
      };
      codes = $("[id^=addSubnetIP_opt_code_]");
      types = $("[id^=addSubnetIP_opt_type_]");
      if (codes.length > 0) {
        next_sub.options = [];

        for (var i = 0; i < codes.length; i++) {
          var c = codes[i].id.split("__")[1];
          var toAdd = false;
          values = $("[id^=addSubnetIP_opt_val_" + c + "_]");
          obj = {
            code: parseInt(c),
            type: parseInt(types[i].id.split("__")[1]),
            value: [],
          };
          for (var j = 0; j < values.length; j++) {
            if (values[j].value.length > 0) {
              toAdd = true;
              obj.value.push(values[j].value);
            }
          }
          if (toAdd) {
            next_sub.options.push(obj);
          }
        }
      }
      cmd = {
        service: "dhcp",
        access: "set",
        command: "set subnet",
        parameters: next_sub,
      };
      $.post("/api", JSON.stringify(cmd), function (data, status) {
        cleanupAddSubnet();
        getSubnets();
      });
    }

    function cleanupAddSubnet() {
      $("#addSubnetIP")[0].value = "";
      $("#addSubnetMask")[0].value = "";
      $("#addSubnetLeasetime")[0].value = "86400";
      $("#addSubnetPoolStart")[0].value = "0.0.0.0";
      $("#addSubnetPoolEnd")[0].value = "0.0.0.0";

      tab = $("#AddSubnetTable")[0];
      opt = $("#addSubnetOptionSetting")[0];
      tab.rows[tab.rows.length - 1].prepend(opt);
      while (tab.rows.length > 7) {
        tab.rows[6].remove();
      }

      code = $("#addOptCode")[0];
      while (code.children.length > 0) {
        code.children[0].remove();
      }
      //code.add
      d = Object.entries(gCodes);
      for (var i = 0; i < d.length; i++) {
        var opt = document.createElement("option");
        opt.value = d[i][1];
        opt.innerText = d[i][0];
        code.appendChild(opt);
      }
      $("#addSubnetAddOption")[0].disabled = false;
    }

    function removeLease(e) {
      var target = e.target;
      ip = target.id.split("_")[2];
      $.post(
        "/api",
        '{"service":"dhcp","access":"set","command":"remove cfg leases","parameters":{"ip":"' +
          ip +
          '"}}',
        function (data, status) {
          getStaticLeases();
        }
      );
    }

    function addOptiontoSubnet() {
      tab = $("#AddSubnetTable")[0];
      row = tab.insertRow(tab.rows.length - 1);
      row.setAttribute("class", "table_row_content");
      opt = $("#addSubnetOptionSetting")[0];
      opt.rowSpan += 1;
      var c1;
      var c2;
      var c3;
      select_code = $("#addOptCode")[0];
      var opt_id = parseInt(select_code.value);
      if (tab.rows.length == 7) {
        row.appendChild(opt);
        c1 = row.insertCell(1);
        c2 = row.insertCell(2);
        c3 = row.insertCell(3);
        c4 = row.insertCell(4);
      } else {
        c1 = row.insertCell(0);
        c2 = row.insertCell(1);
        c3 = row.insertCell(2);
        c4 = row.insertCell(3);
      }
      code_val = select_code.value;
      c1.innerText = getCodeName(parseInt(select_code.value));
      c1.id = "addSubnetIP_opt_code_" + opt_id + "__" + code_val;

      c2.innerText = getType(parseInt($("#addOptType")[0].value));
      c2.id =
        "addSubnetIP_opt_type_" + opt_id + "__" + $("#addOptType")[0].value;
      inp = document.createElement("input");
      c3.appendChild(inp);

      rem = document.createElement("button");
      rem.innerText = "remove";
      rem.id = "addSubnetIP_opt_val_" + opt_id + "remove";
      rem.onclick = removeOptionAddSubnet;
      c4.appendChild(rem);

      row.id = "addSubnetIP_opt_val_" + opt_id + "row";

      if (HasTypeMultipleOptions($("#addOptType")[0].value)) {
        delButton = document.createElement("button");
        delButton.textContent = "-";
        delButton.id = "addSubnetIP_opt_val_" + opt_id + "del";
        delButton.onclick = removeOptionValue;
        delButton.disabled = true;
        c3.appendChild(delButton);
        addButton = document.createElement("button");
        addButton.textContent = "+";
        addButton.id = "addSubnetIP_opt_val_" + opt_id + "plus";
        addButton.onclick = addOptionValue;
        c3.appendChild(addButton);
      }

      inp.id = "addSubnetIP_opt_val_" + opt_id + "_0";

      for (var i = 0; i < select_code.length; i++) {
        if (select_code.options[i].value == code_val) {
          select_code.remove(i);
        }
      }
      if (select_code.length == 0) {
        $("#addSubnetAddOption")[0].disabled = true;
      } else {
        change_add_sub_opt_code();
      }
    }

    function addStaticLease() {
      // {"service":"dhcp","access":"set","command":"add cfg leases","parameters":{"ip": "192.168.11.55", "type": 1, "value": ["AA:FF:DE:AD:BE:EF"], "options":[]}}
      para = {
        ip: $("#staticLease_ip").val(),
      };
      if ($("#staticLease_type")[0].value == "MAC") {
        para.type = 1;
        para.value = [$("#staticLease_mac").val()];
      } else {
        para.type = 0;
        para.value = [
          parseInt($("#staticLease_p_vid").val()),
          parseInt($("#staticLease_p_port").val()),
        ];
      }
      opt = [];
      if ($("#staticLease_add_opt")[0].value != "None") {
        opt.push({
          code: 125,
          type: 4,
          value: [
            $("#staticLease_opt_dep_arc").val(),
            $("#staticLease_opt_dep_file").val(),
          ],
        });
      }
      para.options = opt;
      json = {
        service: "dhcp",
        access: "set",
        command: "add cfg leases",
        parameters: para,
      };
      $.post("/api", JSON.stringify(json), function (data, status) {
        getStaticLeases();
      });
    }

    function change_old_sub_opt_code(e) {
      var target = e.target;
      index = parseInt(target.id.split("_")[3]);

      ts = $("#subnet_opt_addtype_" + index)[0];

      if (target.value == "3" || target.value == "6" || target.value == "42") {
        for (i = 0; i < ts.length; i++) {
          if (i == 0) {
            ts[i].disabled = false;
          } else {
            ts[i].disabled = true;
          }
        }
        ts.value = 0;
      } else if (target.value == "1") {
        for (i = 0; i < ts.length; i++) {
          if (i == 1) {
            ts[i].disabled = false;
          } else {
            ts[i].disabled = true;
          }
        }
        ts.value = 1;
      } else if (target.value == "15") {
        for (i = 0; i < ts.length; i++) {
          if (i == 1) {
            ts[i].disabled = false;
          } else {
            ts[i].disabled = true;
          }
        }
        ts.value = 2;
      } else if (target.value == "125") {
        for (i = 0; i < ts.length; i++) {
          if (i == 2) {
            ts[i].disabled = false;
          } else {
            ts[i].disabled = true;
          }
        }
        ts.value = 4;
      }
    }

    function change_add_sub_opt_code() {
      if (
        $("#addOptCode")[0].value == "3" ||
        $("#addOptCode")[0].value == "6" ||
        $("#addOptCode")[0].value == "42"
      ) {
        ts = $("#addOptType")[0];
        for (i = 0; i < ts.length; i++) {
          if (i == 0) {
            ts[i].disabled = false;
          } else {
            ts[i].disabled = true;
          }
        }
        ts.value = 0;
      } else if ($("#addOptCode")[0].value == "1") {
        ts = $("#addOptType")[0];
        for (i = 0; i < ts.length; i++) {
          if (i == 1) {
            ts[i].disabled = false;
          } else {
            ts[i].disabled = true;
          }
        }
        ts.value = 1;
      } else if ($("#addOptCode")[0].value == "15") {
        ts = $("#addOptType")[0];
        for (i = 0; i < ts.length; i++) {
          if (i == 1) {
            ts[i].disabled = false;
          } else {
            ts[i].disabled = true;
          }
        }
        ts.value = 2;
      } else if ($("#addOptCode")[0].value == "125") {
        ts = $("#addOptType")[0];
        for (i = 0; i < ts.length; i++) {
          if (i == 2) {
            ts[i].disabled = false;
          } else {
            ts[i].disabled = true;
          }
        }
        ts.value = 4;
      }
    }

    function change_add_static_lease_type() {
      if ($("#staticLease_type")[0].value == "MAC") {
        $("#staticLease_port_div")[0].style.display = "none";
        $("#staticLease_mac_div")[0].style.display = "";
      } else {
        $("#staticLease_mac_div")[0].style.display = "none";
        $("#staticLease_port_div")[0].style.display = "";
      }
    }

    function change_add_static_lease_opt() {
      if ($("#staticLease_add_opt")[0].value == "None") {
        $("#staticLease_opt_type")[0].disabled = true;
        $("#staticLease_opt_type")[0].style.visibility = "hidden";
        $("#staticLease_opt_dep_arc")[0].disabled = true;
        $("#staticLease_opt_dep_file")[0].disabled = true;
        $("#static_lease_deploydata")[0].style.visibility = "hidden";
      } else {
        $("#staticLease_opt_type")[0].disabled = false;
        $("#staticLease_opt_type")[0].style.visibility = "";
        $("#staticLease_opt_dep_arc")[0].disabled = false;
        $("#staticLease_opt_dep_file")[0].disabled = false;
        $("#static_lease_deploydata")[0].style.visibility = "";
      }
    }

    function getCodeName(code) {
      if (code == 1) {
        return "Subnet Mask";
      }
      if (code == 3) {
        return "Router";
      }
      if (code == 6) {
        return "Domain Server";
      }
      if (code == 15) {
        return "Domain Name";
      }
      if (code == 42) {
        return "NTP Servers";
      }
      if (code == 125) {
        return "V-I Vendor-Specific Information";
      }
      return "code " + code;
    }

    function getType(type_code) {
      if (type_code == 0) {
        return "IP Address";
      }
      if (type_code == 1) {
        return "Subnet Mask";
      }
      if (type_code == 2) {
        return "String";
      }
      if (type_code == 4) {
        return "Auto Deployment";
      }
      return "type: " + type_code;
    }

    function updateCheckbox(e) {
      var target = e.target;
      id = target.id;
      d = id.split("_cb_");
      if (target.checked) {
        $("#" + d[0] + "_start_" + d[1])[0].disabled = false;
        $("#" + d[0] + "_end_" + d[1])[0].disabled = false;
      } else {
        $("#" + d[0] + "_start_" + d[1])[0].disabled = true;
        $("#" + d[0] + "_start_" + d[1])[0].value = "0.0.0.0";
        $("#" + d[0] + "_end_" + d[1])[0].disabled = true;
        $("#" + d[0] + "_end_" + d[1])[0].value = "0.0.0.0";
      }
    }

    function addOptiontoOldSubnet(e) {
      var target = e.target;
      index = parseInt(target.id.split("_")[3]);
      code = $("#subnet_opt_addcode_" + index)[0];
      type = $("#subnet_opt_addtype_" + index)[0];

      opt_rows = $("[id^=subnet_opt_row_" + index + "_]");
      var row = null;
      if (opt_rows.length == 0) {
        var opt_cell = $("#option_cell_" + index)[0];
        row = document.createElement("tr");
        row.setAttribute("class", "table_row_content");
        var addOptRow = opt_cell.parentElement;
        var tab = addOptRow.parentElement;
        tab.insertBefore(row, addOptRow);
        row.appendChild(addOptRow.children[0]);
        opt_cell.rowSpan += 1;
      } else {
        lastrow = opt_rows[opt_rows.length - 1];
        row = document.createElement("tr");
        row.setAttribute("class", "table_row_content");
        lastrow.after(row);

        opt_rows[0].children[0].rowSpan += 1;
      }

      row.id = "subnet_opt_row_" + index + "_" + code.value;

      h1 = row.insertCell();
      h1.innerText = getCodeName(code.value);
      h1.id =
        "subnet_opt_data_" +
        index +
        "_opt_code_" +
        code.value +
        "__" +
        code.value;
      h2 = row.insertCell();
      h2.innerText = getType(type.value);
      h2.id =
        "subnet_opt_data_" +
        index +
        "_opt_type_" +
        code.value +
        "__" +
        type.value;
      h3 = row.insertCell();
      inp = document.createElement("input");
      inp.id = "subnet_opt_data_" + index + "_opt_val_" + code.value + "_0";
      h3.appendChild(inp);

      if (HasTypeMultipleOptions(type.value)) {
        delButton = document.createElement("button");
        delButton.textContent = "-";
        delButton.id =
          "subnet_opt_data_" + index + "_opt_val_" + code.value + "del";
        delButton.onclick = removeOptionValue;
        delButton.disabled = true;
        h3.appendChild(delButton);
        addButton = document.createElement("button");
        addButton.textContent = "+";
        addButton.id =
          "subnet_opt_data_" + index + "_opt_val_" + code.value + "plus";
        addButton.onclick = addOptionValue;
        h3.appendChild(addButton);
      }

      h4 = row.insertCell();
      rem = document.createElement("button");
      rem.innerText = "remove";
      rem.id = "subnet_opt_data_" + index + "_opt_val_" + code.value + "remove";
      rem.onclick = removeOptionEditSubnet;
      h4.appendChild(rem);

      for (var i = 0; i < code.length; i++) {
        if (code.options[i].value == code.value) {
          code.remove(i);
        }
      }
      if (code.length == 0) {
        $("#subnet_opt_addbutton_" + index)[0].disabled = true;
      } else {
        change_old_sub_opt_code({ target: code });
      }
    }

    function getSubnets() {
      $.post(
        "/api",
        '{"service":"dhcp","access":"get","command":"get subnet"}',
        function (data, status) {
          var div = $("#Subnets")[0];

          while (div.children.length > 0) {
            div.children[0].remove();
          }

          for (subnet_nr = 0; subnet_nr < data.length; subnet_nr++) {
            subnet = data[subnet_nr];
            var tab = document.createElement("table");
            tab.style.fontSize = "80%";
            tab.style.textAlign = "center";
            tab.style.width = "100%";
            var head_row = tab.insertRow();
            head_row.setAttribute("class", "table_row_head");
            var h1 = head_row.insertCell(0);
            h1.innerText = "Setting";
            var h2 = head_row.insertCell(1);
            h2.colSpan = 4;
            h2.innerText = "Value";

            var ip_row = tab.insertRow();
            ip_row.setAttribute("class", "table_row_content");
            ip_row.insertCell(0).textContent = "Network Address";
            h2 = ip_row.insertCell(1);
            h2.colSpan = 4;
            h2.id = "subnet_ip_" + subnet_nr;
            h2.textContent = subnet.ip;

            var mask_row = tab.insertRow();
            mask_row.setAttribute("class", "table_row_content");
            mask_row.insertCell(0).textContent = "Network Mask";
            h2 = mask_row.insertCell(1);
            h2.colSpan = 4;
            h2.id = "subnet_mask_" + subnet_nr;
            h2.textContent = subnet.mask;

            var time_row = tab.insertRow();
            time_row.setAttribute("class", "table_row_content");
            time_row.insertCell(0).textContent = "Leasetime (s)";
            h2 = time_row.insertCell(1);
            h2.colSpan = 4;
            leasetime = document.createElement("input");
            leasetime.type = "text";
            leasetime.value = subnet.leasetime;
            leasetime.id = "subnet_lease_time_" + subnet_nr;
            h2.appendChild(leasetime);

            var pool_start_row = tab.insertRow();
            pool_start_row.setAttribute("class", "table_row_content");
            pool_start_row.insertCell(0).textContent = "Pool";
            h2 = pool_start_row.insertCell(1);
            h2.colSpan = 4;
            h2.innerText = "enable";
            cb = document.createElement("input");
            cb.type = "checkbox";
            cb.id = "subnet_pool_cb_" + subnet_nr;
            h2.appendChild(cb);
            p1 = document.createElement("input");
            p1.id = "subnet_pool_start_" + subnet_nr;
            p1.value = subnet.pool_start;
            p2 = document.createElement("input");
            document.createElement("textarea");
            p2.id = "subnet_pool_end_" + subnet_nr;
            p2.value = subnet.pool_end;
            h2.appendChild(p1);
            h2.appendChild(p2);

            if (subnet.pool_start == "0.0.0.0") {
              cb.checked = false;
              p1.disabled = true;
              p2.value = "0.0.0.0";
              p2.disabled = true;
            } else {
              cb.checked = true;
            }
            cb.onchange = updateCheckbox;
            cb.onclick = updateCheckbox;

            var opt_row = tab.insertRow();
            opt_row.setAttribute("class", "table_row_content");
            h1 = opt_row.insertCell(0);
            h1.textContent = "Option";
            h1.id = "option_cell_" + subnet_nr;
            if (subnet.options.length > 0) {
              h1.rowSpan = subnet.options.length + 1;
            } else {
              h1.rowSpan = 2;
            }
            var cur_row = opt_row;
            for (var i = 0; i < subnet.options.length; i++) {
              var h2;
              var h3;
              var h4;
              var h5;
              if (i != 0) {
                cur_row = tab.insertRow();
                cur_row.id =
                  "subnet_opt_row_" + subnet_nr + "_" + subnet.options[i].code;
                cur_row.setAttribute("class", "table_row_content");

                h2 = cur_row.insertCell(0);
                h3 = cur_row.insertCell(1);
                h4 = cur_row.insertCell(2);
                h5 = cur_row.insertCell(3);
              } else {
                cur_row.id =
                  "subnet_opt_row_" + subnet_nr + "_" + subnet.options[i].code;
                h2 = cur_row.insertCell(1);
                h3 = cur_row.insertCell(2);
                h4 = cur_row.insertCell(3);
                h5 = cur_row.insertCell(4);
              }
              h2.innerText = getCodeName(subnet.options[i].code);
              h2.id =
                "subnet_opt_data_" +
                subnet_nr +
                "_opt_code_" +
                subnet.options[i].code +
                "__" +
                subnet.options[i].code;
              h3.innerText = getType(subnet.options[i].type);
              h3.id =
                "subnet_opt_data_" +
                subnet_nr +
                "_opt_type_" +
                subnet.options[i].code +
                "__" +
                subnet.options[i].type;
              op = document.createElement("input");
              op.value = subnet.options[i].value[0];
              op.id =
                "subnet_opt_data_" +
                subnet_nr +
                "_opt_val_" +
                subnet.options[i].code +
                "_0";
              h4.appendChild(op);

              for (var j = 1; j < subnet.options[i].value.length; j++) {
                br = document.createElement("br");
                h4.appendChild(br);
                op = document.createElement("input");
                op.id =
                  "subnet_opt_data_" +
                  subnet_nr +
                  "_opt_val_" +
                  subnet.options[i].code +
                  "_" +
                  j;
                op.value = subnet.options[i].value[j];
                h4.appendChild(op);
              }

              if (HasTypeMultipleOptions(subnet.options[i].type)) {
                delButton = document.createElement("button");
                delButton.textContent = "-";
                delButton.id =
                  "subnet_opt_data_" +
                  subnet_nr +
                  "_opt_val_" +
                  subnet.options[i].code +
                  "del";
                delButton.onclick = removeOptionValue;
                h4.appendChild(delButton);
                addButton = document.createElement("button");
                addButton.textContent = "+";
                addButton.id =
                  "subnet_opt_data_" +
                  subnet_nr +
                  "_opt_val_" +
                  subnet.options[i].code +
                  "plus";
                addButton.onclick = addOptionValue;
                h4.appendChild(addButton);

                if (subnet.options[i].value.length > 1) {
                  addButton.disabled = true;
                  delButton.disabled = false;
                } else {
                  addButton.disabled = false;
                  delButton.disabled = true;
                }
              }

              rem = document.createElement("button");
              rem.innerText = "remove";
              rem.id =
                "subnet_opt_data_" +
                subnet_nr +
                "_opt_val_" +
                subnet.options[i].code +
                "remove";
              rem.onclick = removeOptionEditSubnet;
              h5.appendChild(rem);
            }
            var add_row = null;
            if (subnet.options.length == 0) {
              add_row = cur_row;
            } else {
              add_row = tab.insertRow();
              add_row.setAttribute("class", "table_row_content");
            }

            // add Options
            h2 = add_row.insertCell();
            h3 = add_row.insertCell();
            h4 = add_row.insertCell();

            var code_select = document.createElement("select");
            for (const [key, val] of Object.entries(gCodes)) {
              var toadd = true;

              for (var i = 0; i < subnet.options.length; i++) {
                if (subnet.options[i].code == val) {
                  toadd = false;
                  break;
                }
              }
              if (toadd) {
                var opt = document.createElement("option");
                opt.value = val;
                opt.text = key;
                code_select.appendChild(opt);
              }
            }
            code_select.id = "subnet_opt_addcode_" + subnet_nr;
            code_select.onchange = change_old_sub_opt_code;
            h2.appendChild(code_select);

            var type_select = document.createElement("select");
            for (const [key, val] of Object.entries(gTypes)) {
              var opt = document.createElement("option");
              opt.value = val;
              opt.text = key;

              type_select.appendChild(opt);
            }
            type_select.id = "subnet_opt_addtype_" + subnet_nr;
            type_select.style.visibility = "hidden";
            h3.appendChild(type_select);

            addButton = document.createElement("button");
            addButton.textContent = "Add Option";
            addButton.id = "subnet_opt_addbutton_" + subnet_nr;
            addButton.onclick = addOptiontoOldSubnet;

            h4.colSpan = 2;
            h4.appendChild(addButton);

            div.appendChild(tab);

            if (code_select.length == 0) {
              addButton.disabled = true;
            } else {
              change_old_sub_opt_code({ target: code_select });
            }

            // update button
            upd = document.createElement("button");
            upd.textContent = "Update Subnet";
            upd.onclick = updateSubnet;
            upd.id = "updateSubnet_" + subnet_nr;
            div.appendChild(upd);
            // remove button
            del = document.createElement("button");
            del.textContent = "Remove Subnet";
            del.onclick = removeSubnet;
            del.id = "removeSubnet_" + subnet_nr;
            div.appendChild(del);

            div.appendChild(document.createElement("br"));
            div.appendChild(document.createElement("br"));
          }
        }
      );
    }

    function getStaticLeases() {
      $.post(
        "/api",
        '{"service":"dhcp","access":"get","command":"get cfg leases"}',
        function (data, status) {
          var tab = $("#StaticLeases")[0];
          while (tab.rows.length > 2) tab.rows[1].remove(1);

          //data.forEach(function(lease) {
          for (i = 0; i < data.length; i++) {
            lease = data[i];
            var tr = tab.insertRow(tab.rows.length - 1);
            tr.className = "table_row_content";

            var t0 = tr.insertCell(0);
            var t1 = tr.insertCell(1);
            var t2 = tr.insertCell(2);
            var t3 = tr.insertCell(3);
            var t4 = tr.insertCell(4);
            t3.colSpan = 3;

            t0.textContent = lease.ip;
            if (lease.type == 0) {
              t1.textContent = "Port based";
              t2.textContent =
                "VLAN ID: " +
                lease.value[0] +
                " Port: " +
                SwitchPortNames[lease.value[1]];
            } else if (lease.type == 1) {
              t1.textContent = "MAC";
              t2.textContent = lease.value[0];
            }
            lease.options.forEach(function (opt) {
              // TODO works only with one
              //var o1 = tr.insertCell();
              var o2 = tr.insertCell(4);
              var o3 = tr.insertCell(5);
              t3.textContent = getCodeName(opt.code);
              t3.colSpan = 1;
              if (opt.type == 4) {
                t0.rowSpan += 1;
                t1.rowSpan += 1;
                t2.rowSpan += 1;
                t3.rowSpan += 1;
                t4.rowSpan += 1;
                o2.rowSpan += 1;
                o2.textContent = getType(opt.type);
                o3.textContent = "Archive url: " + opt.value[0];
                var tr2 = tab.insertRow(tab.rows.length - 1);
                tr2.className = "table_row_content";
                tr2.insertCell(0).innerText = "Filename: " + opt.value[1];
              }
            });

            del_button = document.createElement("button");
            del_button.id = "del_static_" + lease.ip;
            del_button.textContent = "remove";
            del_button.onclick = removeLease;
            t4.appendChild(del_button);
          }
        }
      );
    }

    function getVids() {
      $.post(
        "/api",
        '{"service":"dhcp","access":"get","command":"get vids"}',
        function (data, status) {
          var tab = $("#VlanSettings")[0];
          while (tab.rows.length > 1) tab.rows[1].remove();
          $("#staticLease_p_vid").find("option").remove();
          data.forEach(function (vid) {
            var tr = tab.insertRow(-1);
            tr.className = "table_row_content";

            var t0 = tr.insertCell(0);
            var t1 = tr.insertCell(1);

            if (vid.vid == 0) {
              t0.textContent = "Lan";
            } else {
              t0.textContent = "VLAN_ID" + vid.vid;
            }

            var sel = document.createElement("select");
            sel.id = "vid_sel_" + vid.vid;
            var o1 = document.createElement("option");
            o1.value = "server";
            o1.text = "Server";
            sel.appendChild(o1);
            var o2 = document.createElement("option");
            o2.value = "relay";
            o2.text = "Relay";
            sel.appendChild(o2);
            var o3 = document.createElement("option");
            o3.value = "inserter";
            o3.text = "inserter";
            sel.appendChild(o3);
            var o4 = document.createElement("option");
            o4.value = "off";
            o4.text = "off";
            sel.appendChild(o4);
            sel.value = vid.type;
            t1.appendChild(sel);

            sel = $("#staticLease_p_vid")[0];
            var opt = document.createElement("option");
            opt.value = vid.vid;
            opt.text = vid.vid;

            sel.appendChild(opt);
          });
        }
      );
    }

    function setVids() {
      para = [];
      sels = $("[id^=vid_sel_");
      for (var i = 0; i < sels.length; i++) {
        var vid = parseInt(sels[i].id.split("_")[2]);
        var type = sels[i].value;
        para.push({ vid: vid, type: type });
      }
      cmd = {
        service: "dhcp",
        access: "set",
        command: "set vids",
        parameters: para,
      };
      $.post("/api", JSON.stringify(cmd), function (data, status) {
        getVids();
      });
    }
  </script>
  <body
    style="
      height: 100%;
      width: 100%;
      float: left;
      margin: 0px;
      font-family: Verdana;
      height: 100%;
      overflow: hidden;
      position: absolute;
    "
  >
    <div id="content" style="height: 100%; overflow: auto; width: 100%">
      <div style="width: 100%; float: left">
        <h2 style="margin-left: 10px">Settings &gt; DHCP Server</h2>

        <div class="box2" style="width: calc(100% - 20px)">
          <a class="headline">DHCP per Interface</a>
          <div class="box_content">
            <table
              style="font-size: 80%; text-align: center; width: 100%"
              id="VlanSettings"
            >
              <tr class="table_row_head">
                <td>Interface</td>
                <td>Status DHCP</td>
              </tr>
            </table>
          </div>
          <input id="update_vids" type="button" value="Set" />
        </div>

        <div class="box2" style="width: calc(100% - 20px)">
          <a class="headline">DHCP Server Settings for IP Networks</a>
          <div class="box_content" id="Subnets"></div>
        </div>
        <div class="box2" style="width: calc(100% - 20px)">
          <a class="headline">Add IP Network to DHCP Server</a>
          <div class="box_content">
            <table
              style="font-size: 80%; text-align: center; width: 100%"
              id="AddSubnetTable"
            >
              <tr class="table_row_head">
                <td>Setting</td>
                <td colspan="4">Value</td>
              </tr>
              <tr class="table_row_content">
                <td>Interface</td>
                <td colspan="4">
                  <select id="ipInterfaces">
                    <option></option>
                  </select>
                </td>
              </tr>
              <tr class="table_row_content">
                <td>Network Address</td>
                <td colspan="4">
                  <input type="text" id="addSubnetIP" disabled />
                </td>
              </tr>
              <tr class="table_row_content">
                <td>Network Mask</td>
                <td colspan="4">
                  <input type="text" id="addSubnetMask" disabled />
                </td>
              </tr>
              <tr class="table_row_content">
                <td>Leasetime &#040;s&#041;</td>
                <td colspan="4">
                  <input type="text" id="addSubnetLeasetime" value="86400" />
                </td>
              </tr>
              <tr class="table_row_content">
                <td>Pool</td>
                <td colspan="4">
                  <input
                    type="text"
                    id="addSubnetPoolStart"
                    value="0.0.0.0"
                  />-<input type="text" id="addSubnetPoolEnd" value="0.0.0.0" />
                </td>
              </tr>
              <tr class="table_row_content">
                <td id="addSubnetOptionSetting">Options</td>
                <td>
                  <select id="addOptCode">
                    <option value="1">Subnet Mask</option>
                    <option value="3">Router</option>
                    <option value="6">Domain Server</option>
                    <option value="15">Domain Name</option>
                    <option value="42">NTP Servers</option>
                  </select>
                </td>
                <td>
                  <select id="addOptType" style="visibility: hidden">
                    <option value="0">IP Address</option>
                    <option value="1">Single IP Address</option>
                    <option value="2">String</option>
                  </select>
                </td>
                <td colspan="2">
                  <input
                    type="button"
                    id="addSubnetAddOption"
                    value="Add Option"
                  />
                </td>
              </tr>
            </table>
            <input id="add_Subnet" type="button" value="Add IP Network" />
          </div>
        </div>

        <div class="box2" style="width: calc(100% - 20px)">
          <a class="headline">Static Leases </a>
          <div class="box_content">
            <table
              style="font-size: 80%; text-align: center; width: 100%"
              id="StaticLeases"
            >
              <tr class="table_row_head">
                <td>IP Address</td>
                <td>Type</td>
                <td>Value</td>
                <td colspan="3">Options</td>
                <td>Actions</td>
              </tr>
              <tr class="table_row_content">
                <td>
                  <input type="text" id="staticLease_ip" />
                </td>
                <td>
                  <select id="staticLease_type">
                    <option id="0">Port based</option>
                    <option id="1">MAC</option>
                  </select>
                </td>
                <td>
                  <div style="display: none" id="staticLease_port_div">
                    VLAN ID:
                    <select id="staticLease_p_vid"></select
                    ><br />
                    Port:
                    <select id="staticLease_p_port"></select>
                  </div>
                  <div style="display: none" id="staticLease_mac_div">
                    <input type="text" id="staticLease_mac" />
                  </div>
                </td>
                <td>
                  <select id="staticLease_add_opt">
                    <option>None</option>
                    <option>V-I Vendor-Specific Information</option>
                  </select>
                </td>
                <td>
                  <select id="staticLease_opt_type">
                    <option>Auto Deployment</option>
                  </select>
                </td>
                <td>
                  <div id="static_lease_deploydata">
                    Archive url:
                    <input type="text" id="staticLease_opt_dep_arc" /><br />
                    Filename:
                    <input type="text" id="staticLease_opt_dep_file" />
                  </div>
                </td>
                <td>
                  <input
                    id="add_staticLease"
                    type="button"
                    value="Add Static Leases"
                  />
                </td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
