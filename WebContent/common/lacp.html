<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="basic_layout.css" />
  </head>
  <script type="text/javascript" src="basic_jscript.js"></script>
  <script type="text/javascript" src="js/jquery-3.7.1.min.js"></script>
  <script type="text/javascript" src="js/utils.js"></script>
  <script type="text/javascript">
    var bond_data = {};

    function updateDisable() {
      for (var j = 0; j < Order.length; j++) {
        var dis = $('[id^="ch_' + SwitchPortNames[Order[j]] + '_"]');
        var disable = false;
        var num = "-1";
        for (var i = 0; i < dis.length; i++) {
          if (dis[i].checked) {
            disable = true;
            num = dis[i].id.split("_")[2];
            break;
          }
        }

        if (disable) {
          dis.prop("checked", false);
          dis.prop("disabled", true);
          $("#ch_" + SwitchPortNames[Order[j]] + "_" + num).prop(
            "checked",
            true
          );
          $("#ch_" + SwitchPortNames[Order[j]] + "_" + num).prop(
            "disabled",
            window.userLevel === 0 ? false : true
          );
        } else {
          var dis = $("[id^=ch_" + SwitchPortNames[Order[j]] + "_]").prop(
            "disabled",
            window.userLevel === 0 ? false : true
          );
        }
      }
      for (key of Object.keys(bond_data)) {
        sels = $("input[id^='ch'][id$='" + key + "']");
        cnt_active = 0;
        for (i = 0; i < sels.length; i++) {
          if (sels[i].checked) {
            cnt_active++;
          }
        }
        if (cnt_active >= 8) {
          for (i = 0; i < sels.length; i++) {
            if (sels[i].checked) {
              sels[i].disabled = window.userLevel === 0 ? false : true;
            } else {
              sels[i].disabled = true;
            }
          }
        }
      }
    }

    function getBonds(data) {
      var tab = $("#bonds_table")[0];
      while (tab.rows.length > 1) tab.rows[0].remove();

      bond_data = data;

      var head_row = tab.insertRow(-1);
      head_row.className = "table_row_head";
      var t0 = head_row.insertCell();
      t0.appendChild(document.createTextNode("Port"));

      for (var bond in data) {
        var tc = head_row.insertCell();
        tc.appendChild(document.createTextNode(bond));
      }

      var tr = tab.insertRow(-1);

      var t0 = tr.insertCell(0);

      for (var i = 0; i < Order.length; i++) {
        var tr = tab.insertRow(-1);

        var t0 = tr.insertCell(0);

        tr.className = "table_row_content";

        t0.innerText = SwitchPortNames[Order[i]];

        for (var bond in data) {
          var tc = tr.insertCell();
          var ch_i = document.createElement("input");
          ch_i.type = "checkbox";
          ch_i.id = "ch_" + SwitchPortNames[Order[i]] + "_" + bond;
          ch_i.checked = false;
          ch_i.disabled = window.userLevel === 1;

          for (var k of data[bond].lower_interfaces) {
            if (k == SwitchPortNames[Order[i]]) {
              // check
              ch_i.checked = true;
            }
          }
          tc.appendChild(ch_i);
        }
      }
      $("[id^=ch_]").on("change", updateDisable);
      updateDisable();
    }

    function set() {
      obj = {};

      for (key of Object.keys(bond_data)) {
        var lower = [];
        var b = {};
        sels = $('input[id^="ch_"][id$="' + key + '"]');
        for (var i = 0; i < sels.length; i++) {
          if (sels[i].checked) {
            lower.push(sels[i].id.split("_")[1]);
          }
        }
        b["lower_interfaces"] = lower;
        obj[key] = b;
      }

      $.post(
        "/api",
        JSON.stringify({
          service: "vlan",
          access: "set",
          command: "set bonds",
          parameters: obj,
        }),
        function (data, status) {
          createOK(data);
        }
      );
    }

    $(document).ready(function () {
      applyAdminRestrictions(function () {
        setupPortInfo(setupDone);
      });
    });

    function setupDone() {
      $(document).ajaxError(function (data, a1) {
        if (a1.responseJSON != undefined)
          $("#infoline").text(a1.responseJSON.msg);
      });

      $("#setBonds").click(set);

      $.post(
        "/api",
        '{"service":"vlan","access":"get","command":"get bonds"}',
        getBonds
      );
    }
  </script>
  <body
    style="
      height: 100%;
      width: 100%;
      float: left;
      margin: 0px;
      font-family: Verdana;
      overflow: hidden;
      position: absolute;
    "
  >
    <div id="content" style="height: 100%; overflow: auto; width: 100%">
      <h2 style="margin-left: 10px">Settings &gt; Bonds</h2>

      <div class="box2" style="width: calc(50% - 20px)">
        <a class="headline">LACP</a>
        <div class="box_content">
          <table style="font-size: 80%; width: 100%" id="bonds_table"></table>
        </div>
        <input
          type="button"
          value="Set"
          id="setBonds"
          class="btn btn-admin-only"
          style="display: none"
        />
      </div>
    </div>
  </body>
</html>
