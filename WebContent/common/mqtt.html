<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="basic_layout.css" />
    <style type="text/css"></style>
  </head>
  <script type="text/javascript" src="basic_jscript.js"></script>
  <script type="text/javascript" src="js/jquery-3.7.1.min.js"></script>
  <script type="text/javascript">
    $(document).ajaxError(function (event, request, settings) {
      var obj = JSON.parse(request.responseText);
      if (obj.msg) ffunc(obj.msg);
      if (obj.error === "invalid rights")
        window.top.location.href = "login.html";
    });

    $(document).ready(function () {
      $("#tls_enabled").change(function () {
        let v = !$(this).is(":checked");
        $("#ca_cert").prop("disabled", v);
        $("#verify").prop("disabled", v);
      });
      $("#update_enabled").change(function () {
        let v = !$(this).is(":checked");
        $("#update_topic").prop("disabled", v);
      });
      $("#enable").change(function () {
        let v = !$(this).is(":checked");
        $("#host").prop("disabled", v);
        $("#port").prop("disabled", v);
        $("#username").prop("disabled", v);
        $("#password").prop("disabled", v);
        $("#pingreq_interval").prop("disabled", v);
        $("#tls_enabled").prop("disabled", v);
        $("#qos").prop("disabled", v);
        $("#update_enabled").prop("disabled", v);
      });
      $.post(
        "/api",
        JSON.stringify({ access: "get", command: "get mqtt", service: "mqtt" })
      ).done(function (json_obj) {
        $("#enable").prop("checked", json_obj["enabled"]);
        $("#tls_enabled").prop("checked", json_obj["tls"]);
        $("#qos").val(json_obj["qos"]);
        $("#port").val(json_obj["port"]);
        $("#host").val(json_obj["server"]);
        $("#client_id").val(json_obj["name"]);
        $("#update_enabled").prop("checked", json_obj["update_enabled"]);
        $("#update_topic").val(json_obj["update_topic"]);
        $("#status").html(json_obj["s"]);
        $("#status").css(
          "color",
          json_obj["s"] == "connected" ||
            json_obj["s"] == "disabled" ||
            json_obj["s"] == "updating"
            ? "green"
            : "red"
        );
        $("#username").val(json_obj["username"]);
        $("#password").val(json_obj["password"]);
        $("#ca_cert").val(json_obj["ca_cert"]);
        $("#pingreq_interval").val(json_obj["pingreq_interval"]);
        $("#verify").prop("checked", json_obj["verify"]);
        $("#enable").trigger("change");
        $("#tls_enabled").trigger("change");
        $("#update_enabled").trigger("change");
      });

      $("#set_values").click(function () {
        $.post(
          "/api",
          JSON.stringify({
            access: "get",
            command: "get mqtt",
            service: "mqtt",
          })
        ).done(function (json_obj) {
          json_obj["enabled"] = $("#enable").prop("checked");
          json_obj["tls"] = $("#tls_enabled").prop("checked");
          json_obj["qos"] = Number($("#qos").val());
          json_obj["port"] = Number($("#port").val());
          json_obj["server"] = $("#host").val();
          json_obj["update_enabled"] = $("#update_enabled").prop("checked");
          json_obj["update_topic"] = $("#update_topic").val();
          json_obj["username"] = $("#username").val();
          json_obj["password"] = $("#password").val();
          json_obj["pingreq_interval"] = Number($("#pingreq_interval").val());
          json_obj["verify"] = $("#verify").prop("checked");
          if (document.getElementById("ca_cert").files.length == 0) {
            json_obj["ca_cert"] = "";
          } else if (document.getElementById("ca_cert").files.length > 1) {
            alert("Please select only one CA certificate file.");
            return;
          } else {
            var file = document.getElementById("ca_cert").files[0];
            if (file) {
              var reader = new FileReader();
              reader.onload = function (e) {
                json_obj["ca_cert"] = e.target.result;
                $.post(
                  "/api",
                  JSON.stringify({
                    parameters: json_obj,
                    service: "mqtt",
                    access: "set",
                    command: "set mqtt",
                  })
                );
              };
              reader.readAsText(file);
              return;
            } else if (json_obj["tls"]) {
              alert("Please select a CA certificate file.");
              return;
            }
            json_obj["ca_cert"] = reader.result;
          }
          $.post(
            "/api",
            JSON.stringify({
              parameters: json_obj,
              service: "mqtt",
              access: "set",
              command: "set mqtt",
            })
          );
        });
      });
    });
  </script>

  <body
    style="
      height: 100%;
      width: 100%;
      float: left;
      margin: 0px;
      font-family: Verdana;
      overflow: hidden;
      position: absolute;
    "
  >
    <div id="content" style="height: 100%; overflow: auto; width: 100%">
      <h2 style="margin-left: 10px">Settings &gt; MQTT</h2>
      <div class="box2" style="width: calc(40% - 20px)">
        <a class="headline">General Configuration</a>
        <div class="box_content">
          <table
            style="width: 100%; table-layout: fixed; font-size: 80%"
            id="mqtt_table"
          >
            <tr class="table_row_head">
              <td>Setting</td>
              <td>Value</td>
            </tr>
            <tr class="table_row_content tooltip">
              <td>
                <label for="enable">Enable</label>
                <span class="tooltiptext"
                  >Enable MQTT client, must set at least hostname</span
                >
              </td>
              <td><input type="checkbox" id="enable" /></td>
            </tr>
            <tr class="table_row_content tooltip">
              <td>
                <label for="host">Broker hostname</label>
                <span class="tooltiptext"
                  >Hostname or IP address of the broker</span
                >
              </td>
              <td>
                <input type="text" id="host" placeholder="server.local" />
              </td>
            </tr>
            <tr class="table_row_content tooltip">
              <td>
                <label for="port">Broker port</label>
                <span class="tooltiptext">Port of the broker</span>
              </td>
              <td><input type="number" id="port" placeholder="1883" /></td>
            </tr>
            <tr class="table_row_content tooltip">
              <td>
                <label for="client_id">Client id</label>
                <span class="tooltiptext">Client id for broker</span>
              </td>
              <td>
                <input
                  type="text"
                  id="client_id"
                  placeholder="roqstar"
                  disabled="true"
                />
              </td>
            </tr>
            <tr class="table_row_content tooltip">
              <td>
                <label for="username">Username</label>
                <span class="tooltiptext"
                  >Username for broker authentication</span
                >
              </td>
              <td><input type="text" id="username" /></td>
            </tr>
            <tr class="table_row_content tooltip">
              <td>
                <label for="password">Password</label>
                <span class="tooltiptext"
                  >Password for broker authentication</span
                >
              </td>
              <td><input type="password" id="password" /></td>
            </tr>
            <tr class="table_row_content tooltip">
              <td>
                <label for="tls_enabled">Tls enabled</label>
                <span class="tooltiptext"
                  >Enable TLS connection to broker for encryption and, if verify
                  is enabled, authentication</span
                >
              </td>
              <td><input type="checkbox" id="tls_enabled" /></td>
            </tr>
            <tr class="table_row_content tooltip">
              <td>
                <label for="ca_cert">CA cert</label>
                <span class="tooltiptext"
                  >CA certificate (pem) for TLS connection</span
                >
              </td>
              <td>
                <input type="file" id="ca_cert" accept=".pem, .crt, .cer" />
              </td>
            </tr>
            <tr class="table_row_content tooltip">
              <td>
                <label for="verify">Verify</label>
                <span class="tooltiptext"
                  >Verify hostname with ip addresses given by SAN/CN</span
                >
              </td>
              <td><input type="checkbox" id="verify" /></td>
            </tr>
            <tr class="table_row_content tooltip">
              <td>
                <label for="qos">Qos</label>
                <span class="tooltiptext"
                  >Quality of service level for messages.<br />
                  0 -> At most once<br />1 -> At least once<br />2 -> Always
                  once</span
                >
              </td>
              <td>
                <input type="number" id="qos" value="1" min="0" max="2" />
              </td>
            </tr>
            <tr class="table_row_content tooltip">
              <td>
                <label for="pingreq_interval"
                  >Keep alive interval (seconds)</label
                >
                <span class="tooltiptext"
                  >Interval for sending keepalive pings to broker, should match
                  setting as configured for broker</span
                >
              </td>
              <td>
                <input
                  type="number"
                  id="pingreq_interval"
                  value="120"
                  min="1"
                  max="3600"
                />
              </td>
            </tr>
          </table>
        </div>
        <input
          type="button"
          id="set_values"
          value="Set Mqtt Configuration"
          class="btn"
        />
      </div>
      <div class="box2" style="width: calc(30% - 20px)">
        <a class="headline">Update</a>
        <div class="box_content">
          <table
            style="width: 100%; table-layout: fixed; font-size: 80%"
            id="mqtt_table"
          >
            <tr class="table_row_head">
              <td>Setting</td>
              <td>Value</td>
            </tr>
            <tr class="table_row_content tooltip">
              <td>
                <label for="update_topic">Update subscribe</label>
                <span class="tooltiptext"
                  >Enable update topic subscription</span
                >
              </td>
              <td><input type="checkbox" id="update_enabled" /></td>
            </tr>
            <tr class="table_row_content tooltip">
              <td>
                <label for="update_topic">Update topic</label>
                <span class="tooltiptext">Topic to subscribe for updates</span>
              </td>
              <td>
                <input
                  type="text"
                  id="update_topic"
                  placeholder="roqstar/update"
                />
              </td>
            </tr>
          </table>
        </div>
      </div>
      <div class="box2" style="width: calc(30% - 20px)">
        <a class="headline">Status</a>
        <div class="box_content">
          <table
            style="width: 100%; table-layout: fixed; font-size: 80%"
            id="mqtt_table"
          >
            <tr class="table_row_head">
              <td>System</td>
              <td>Value</td>
            </tr>
            <tr class="table_row_content tooltip">
              <td>
                <div>Status</div>
                <span class="tooltiptext">Status of the MQTT connection</span>
              </td>
              <td>
                <div id="status"></div>
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </body>
</html>
